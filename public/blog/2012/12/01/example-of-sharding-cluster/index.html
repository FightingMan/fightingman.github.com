
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Example of sharding cluster - FightingMan's FootPrints</title>
  <meta name="author" content="FightingMan">

  
  <meta name="description" content="Previous article showed some basic theories of Mongodb sharding,now we&#8217;ll demonstrate it.
Prepare 15 servers:172.16.103.200~172.16.103.214 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://FightingMan.github.com/blog/2012/12/01/example-of-sharding-cluster/">
  <link href="http://www.gnu.org/graphics/gnu-head-mini.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="FightingMan's FootPrints" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">FightingMan's FootPrints</a></h1>
  
    <h2>I know the only way to success for me is do it forever and never give up.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:FightingMan.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Example of Sharding Cluster</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-01T19:45:00+08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Previous article showed some basic theories of Mongodb sharding,now we&#8217;ll demonstrate it.
Prepare 15 servers:172.16.103.200~172.16.103.214</p>

<p><img src="/images/demo.jpeg"></p>

<p>Suppose you had been installed mongodb in /usr/local/mongdb and its structure:</p>

<pre><code>|-- GNU-AGPL-3.0
|-- README
|-- THIRD-PARTY-NOTICES
|-- bin
|   |-- bsondump
|   |-- mongo
|   |-- mongod
|   |-- mongodump
|   |-- mongoexport
|   |-- mongofiles
|   |-- mongoimport
|   |-- mongorestore
|   |-- mongos
|   |-- mongosniff
|   |-- mongostat
|   `-- mongotop
|-- db//Directory
|-- mongodb.conf
`-- mongodb.log
</code></pre>

<!--more-->


<p>1.Configuration servers.//200-202</p>

<pre><code>vi /usr/local/mongodb/mongodb.conf
fork = true
logpath = /usr/local/mongodb/mongodb.log
dbpath = /usr/local/mongodb/db/
logappend=true
journal=true
configsvr=true
/usr/local/mongdb/bin/mongod --config /usr/local/mongodb/mongodb.conf #start it
</code></pre>

<p>2.Mongos.//203-205</p>

<pre><code>vi /usr/local/mongodb/mongodb.conf
fork = true
logpath = /usr/local/mongodb/mongodb.log
logappend=true
configdb=172.16.103.200,172.16.103.201,172.16.103.202
/usr/local/mongdb/bin/mongos --config /usr/local/mongodb/mongodb.conf #start it
</code></pre>

<p>3.Shards.//206-214</p>

<pre><code>vi /usr/local/mongodb/mongodb.conf
fork = true
logpath = /usr/local/mongodb/mongodb.log
dbpath = /usr/local/mongodb/db/
logappend=true
journal=true
#206-208
replSet=sd1
#209-211
replSet=sd2
#212-214
replSet=sd3
/usr/local/mongdb/bin/mongod --config /usr/local/mongodb/mongodb.conf #start it
</code></pre>

<p>4.Replica Set.</p>

<pre><code>#connect to one of sd1's svr//default primary svr
&gt;/usr/local/mongodb/bin/mongo 127.0.0.1:27017/admin
&gt;config = {_id:"sd1",members:[
... {_id:0,host:'172.16.103.206:27017'},
... {_id:1,host:'172.16.103.207:27017'},
... {_id:2,host:'172.16.103.208:27017'}]
... }
&gt;rs.initiate(config);
#connect to one of sd2's svr//default primary svr
&gt;/usr/local/mongodb/bin/mongo 127.0.0.1:27017/admin
&gt;config = {_id:"sd2",members:[
... {_id:0,host:'172.16.103.209:27017'},
... {_id:1,host:'172.16.103.210:27017'},
... {_id:2,host:'172.16.103.211:27017'}]
... }
&gt;rs.initiate(config);
#connect to one of sd2's svr//default primary svr
&gt;/usr/local/mongodb/bin/mongo 127.0.0.1:27017/admin
&gt;config = {_id:"sd3",members:[
... {_id:0,host:'172.16.103.212:27017'},
... {_id:1,host:'172.16.103.213:27017'},
... {_id:2,host:'172.16.103.214:27017'}]
... }
&gt;rs.initiate(config);
</code></pre>

<p>5.Add shards.</p>

<pre><code>#connect to one mongos svr
/usr/local/mongodb/bin/mongo 127.0.0.1:27017/config
#set chunksize,default 64M
db.setting.save({_id:"chunksize",value:64})
#add shards,you can set the maxsize by yourself//default 2048M
use admin
db.runCommand({addshard:"sd1/172.16.103.206:27017,172.16.103.207:27017,172.16.103.208:27017",maxsize:20480})
db.runCommand({addshard:"sd2/172.16.103.209:27017,172.16.103.210:27017,172.16.103.211:27017",maxsize:20480})
db.runCommand({addshard:"sd3/172.16.103.212:27017,172.16.103.213:27017,172.16.103.214:27017",maxsize:20480})
#test comperation success
db.runCommand({listshards:1})#will list all the shards if successed.
#Active DB
db.runCommand({enablesharding:"mydemo"});
#set shard key for collection:user,before you do it , you can create some indexer for the key except unique indexer,if don't mongodb will create one for you automatically.
db.runCommand({shardcollection:"mydemo.user",key:{id:1,name:1}})
</code></pre>

<p>Now every thing have been done,enjoy it :)//Other way,you can test this demo with three svrs just change their default port.</p>

<p>Let&#8217;s talk about the shard key,the most important thing in my mind. <a href="http://docs.mongodb.org/manual/core/sharding/#shard-keys">Docs</a></p>

<p>Choose a good key make you get twice the result with half the effort.//from scaling mongodb.</p>

<p>A general formula //twitter-like.</p>

<pre><code>{coarseLocalityfield:1,searchfield:1}
</code></pre>

<p>Before we choose one,think about the answers to these questions:</p>

<pre><code>What do writes looks like? What is the shape and size of the documents you'er inserting?
How much data is the system writing per hour? Per day?And the peak?
What fields are random, and which ones are increasing?
what do reads look like? What data are people accessing?
How much data is the system reading per hour? Per day?And the peak?
Is the data indexed? Should it be indexed?
How much data is there,total?
</code></pre>

<p>Before you shard, you should get to know your data very well.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">FightingMan</span></span>

      








  


<time datetime="2012-12-01T19:45:00+08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mongodb/'>Mongodb</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/11/29/a-storiette/" title="Previous Post: A storiette">&laquo; A storiette</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/12/03/reinforcement-php-environment-via-php-dot-ini/" title="Next Post: Reinforcement php environment via php.ini">Reinforcement php environment via php.ini &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite">        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'ftman'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/13/big-and-little-endian-in-inet_pton/">big and little endian in inet_pton()</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/13/doubt-of-host-byte-order/">socket编程遇到字节排序的诡异问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/24/short-notes/">short notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/22/a-trap-in-php-base-convert/">A trap in php base_convert</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/13/shell-tips-with-ctrl-plus/">Shell Tips with Ctrl+(?)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/24/my-girl-friend/">My girl friend</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/08/an-interesting-thing-occurs-while-a-class-inside-interface/">An Interesting Thing Occurs While a Class Inside Interface</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/04/connect-to-postgresql-via-msfconsole-in-metasploit/">Connect to postgresql via msfconsole in Metasploit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/03/reinforcement-php-environment-via-php-dot-ini/">Reinforcement php environment via php.ini</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/01/example-of-sharding-cluster/">Example of sharding cluster</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/FightingMan">@FightingMan</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'FightingMan',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
<h1>Category List</h1>
<ul>
  <li><a href='/blog/categories/c-c-'>C/c++</a></li>
  <li><a href='/blog/categories/java'>Java</a></li>
  <li><a href='/blog/categories/life'>Life</a></li>
  <li><a href='/blog/categories/mongodb'>Mongodb</a></li>
  <li><a href='/blog/categories/php'>Php</a></li>
  <li><a href='/blog/categories/security'>Security</a></li>
  <li><a href='/blog/categories/shell'>Shell</a></li>
  <li><a href='/blog/categories/tcp-ip'>Tcp/ip</a></li>
</ul>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - FightingMan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ftman';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://FightingMan.github.com/blog/2012/12/01/example-of-sharding-cluster/';
        var disqus_url = 'http://FightingMan.github.com/blog/2012/12/01/example-of-sharding-cluster/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
