
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Summary of Understanding Mongodb Sharding - FightingMan's FootPrints</title>
  <meta name="author" content="FightingMan">

  
  <meta name="description" content="Sharding is the method Mongodb uses to split a large collection across several servers(called a cluster). A Mongodb cluster basically consists of &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://FightingMan.github.com/blog/2012/11/28/summary-of-understanding-mongodb-sharding/">
  <link href="http://www.gnu.org/graphics/gnu-head-mini.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="FightingMan's FootPrints" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">FightingMan's FootPrints</a></h1>
  
    <h2>I know the only way to success for me is do it forever and never give up.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:FightingMan.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Summary of Understanding Mongodb Sharding</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-28T22:16:00+08:00" pubdate data-updated="true">Nov 28<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Sharding is the method Mongodb uses to split a large collection across several servers(called a cluster).</p>

<p>A Mongodb cluster basically consists of three types of processes:the shards for actually storing data, the mongos processes for routing requests to the correct data,and the config servers,for keeping track of the cluster&#8217;s state.</p>

<p><img src="/images/MongodbCluster.jpeg"></p>

<blockquote><ol>
<li>The Config Servers:
  Config servers hold the definitive information about the cluster for everyone&#8217;s access (shards,mongos processes, and system administrtors).</li>
<li>Mongos:
  Mongos is the interaction point  between users and the cluster..Its job is to hide all of the gooey internals of sharding  and present a clean, single-server interface to the user.Mongos can help you to use targeted query if you query involves the shard key.</li>
<li>Shards:
  A shard is one or more servers in a cluster that are responsible for some subset of the data(more than one server used for replica set usually).</li>
</ol>
</blockquote>

<!--more-->


<p>Shard key And Chunk</p>

<blockquote><p>The key you choose to use for chunk ranges is called a shard key(can be any field or combination of fields).e.g.</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Suppose our collection had documents that looked like this (_ids omitted):
</span><span class='line'>{"username" : "paul", "age" : 23}
</span><span class='line'>{"username" : "simon", "age" : 17}
</span><span class='line'>{"username" : "widdly", "age" : 16}
</span><span class='line'>{"username" : "scuds", "age" : 95}
</span><span class='line'>{"username" : "grill", "age" : 18}
</span><span class='line'>{"username" : "flavored", "age" : 55}
</span><span class='line'>{"username" : "bertango", "age" : 73}
</span><span class='line'>{"username" : "wooster", "age" : 33}
</span><span class='line'>If we choose the age field as a shard key and end up with a chunk range [15, 26),
</span><span class='line'>thechunk would contain the following documents:
</span><span class='line'>{"username" : "paul", "age" : 23}
</span><span class='line'>{"username" : "simon", "age" : 17}
</span><span class='line'>{"username" : "widdly", "age" : 16}
</span><span class='line'>{"username" : "grill", "age" : 18}</span></code></pre></td></tr></table></div></figure>


<p>When you first shard a collection , Mongodb creates a single chunk for whatever data is in the collection,and the has a range of (-∞,+∞),until you inserted more data,-∞ is the smallest value ,+∞ is the largest value.
If you insert enough data into the shards,Mongodb would split the initial chunk into two chunks around the midpoint.So,if approximately half of the documents had a an age field less than 15 and halst were greater than 15(above demo),Mongodb might choose 15 as th midpoint.Then we had two chunks:(-∞,15),[15,+∞).If we continued to insert data into the [15,+∞)chunk,it could be split again,so we have three chunks:(-∞,15),[15,midpoint),[midpoint,+∞).As we insert more data,Mongodb will continued to split existing chunks to create new chunks.
We also can hava a chunk with a single value,but every chunk&#8217;s range must be distincti.you cannot have overlapping chunks,each chunk&#8217;s range must exactly meet the next chunk&#8217;s range.e.g.</p>

<pre><code>if you split a chunk with the range[1,10),you can't have [1,5),[6,10);[1,5],[5,10);[1,5),[4,10).
keep in mind: each document must belong to one and only one chunk.
</code></pre>

<p>Also you can use different type for the documents,but can&#8217;t with empty values,Mongodb would sort it according to its type:</p>

<pre><code>null&lt;numbers&lt;strings&lt;objects&lt;arrays&lt;binary data&lt;ObjectIds&lt;booleans&lt;dates&lt;regular expressions
</code></pre>

<p>Balancer</p>

<blockquote><p>If there are multiple shards available,Mongodb will start migrating data to other shards once you have a sufficient number of chunks.This migration is called balancing and is perfomed bt a process called the balancer.
The balancer moves chunks from one shard to another automatically.
The goal of the balancer is not only to keep the data evenly distributed but also to minimize the amount of data transferred.</p></blockquote>

<p>Multi-range shards</p>

<blockquote><p>Allowing multiple,non-consesutive ranges in a shard allow us to pick and choose data and move it.</p></blockquote>

<p><img src="/images/move1.jpeg"></p>

<blockquote><p>When a new shard is added,everyone can contribute data to it directly.</p></blockquote>

<p><img src="/images/move2.jpeg"></p>

<blockquote><p>For a balancing round to occur, a shard must have at leat nine more chunks than the least-populous shard,so chunks will be migrated off of the crowed shard until it is even with the rest of the shards,because Mongodb wants to avoid sending the same data back and forth.Also keep in mind nine chunks is not even that much of an imbalance-it is less than 2GB of data,as Mongodb want minimize pointless data transfers.</p></blockquote>

<p><img src="/images/avoid.jpeg"></p>

<p>Notice:In a real system, chunks are only 64MB by default,also you can change it in megabytes(db.settings.save( { _id:&#8221;chunksize&#8221;, value: <size>}))</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">FightingMan</span></span>

      








  


<time datetime="2012-11-28T22:16:00+08:00" pubdate data-updated="true">Nov 28<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mongodb/'>Mongodb</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/11/27/basic-snytax-of-inner-class/" title="Previous Post: Basic syntax of inner class">&laquo; Basic syntax of inner class</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/11/29/a-storiette/" title="Next Post: A storiette">A storiette &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite">        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'ftman'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/13/shell-tips-with-ctrl-plus/">Shell Tips with Ctrl+(?)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/24/my-girl-friend/">My girl friend</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/08/an-interesting-thing-occurs-while-a-class-inside-interface/">An Interesting Thing Occurs While a Class Inside Interface</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/04/connect-to-postgresql-via-msfconsole-in-metasploit/">Connect to postgresql via msfconsole in Metasploit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/03/reinforcement-php-environment-via-php-dot-ini/">Reinforcement php environment via php.ini</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/01/example-of-sharding-cluster/">Example of sharding cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/29/a-storiette/">A storiette</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/28/summary-of-understanding-mongodb-sharding/">Summary of Understanding Mongodb Sharding</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/27/basic-snytax-of-inner-class/">Basic syntax of inner class</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/26/some-params-in-php-fpm-with-dynamic-pattern/">Some params in php-fpm with dynamic pattern</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/FightingMan">@FightingMan</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'FightingMan',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
<h1>Category List</h1>
<ul>
  <li><a href='/blog/categories/java'>Java</a></li>
  <li><a href='/blog/categories/life'>Life</a></li>
  <li><a href='/blog/categories/mongodb'>Mongodb</a></li>
  <li><a href='/blog/categories/php'>Php</a></li>
  <li><a href='/blog/categories/security'>Security</a></li>
  <li><a href='/blog/categories/shell'>Shell</a></li>
</ul>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - FightingMan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ftman';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://FightingMan.github.com/blog/2012/11/28/summary-of-understanding-mongodb-sharding/';
        var disqus_url = 'http://FightingMan.github.com/blog/2012/11/28/summary-of-understanding-mongodb-sharding/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
